# 项目间隔与产品线排序优化 - 需求共识文档

## 一、需求确认

经过与用户沟通，已达成以下共识：

### 1.1 需求1：项目间隔显示优化

**最终方案**：
- ✅ **所有项目块**都显示1天的视觉间隔
- ✅ 通过缩短项目块的**视觉宽度**来实现
- ✅ 计算公式：`宽度 = (实际天数) × pixelsPerDay - pixelsPerDay`
- ✅ **不影响数据存储**，用户编辑项目时看到的仍然是实际的开始/结束日期
- ✅ 间隔会随着缩放比例自动调整

**用户确认**：✅ 已确认

### 1.2 需求2：产品线排序功能

**最终方案**：
- ✅ 使用**拖拽排序**交互方式
- ✅ 在产品线管理界面（ProductLineManagement组件）中实现
- ✅ 排序结果持久化保存到后端（产品线模型增加`order`字段）
- ✅ 新创建的产品线默认排在**最后**（order = 当前最大order + 1）
- ✅ 排序同时影响时间轴显示和产品线管理列表

**用户确认**：✅ 已确认

## 二、技术实现方案

### 2.1 需求1：项目间隔显示

**修改范围**：
- 文件：`frontend/src/utils/layoutUtils.js`
- 函数：`calculateProjectBarPosition`

**核心逻辑**：
```javascript
// 原逻辑
const duration = dayjs(project.endDate).diff(project.startDate, 'day') + 1
const width = duration * pixelsPerDay

// 新逻辑
const duration = dayjs(project.endDate).diff(project.startDate, 'day') + 1
const width = duration * pixelsPerDay - pixelsPerDay  // 减去1天的宽度
```

**影响范围**：
- 仅影响视觉呈现
- 不影响数据存储
- 不影响项目编辑功能
- 不影响其他布局逻辑

### 2.2 需求2：产品线排序

**后端修改**：

1. **产品线模型** (`backend/models/productline.py`)
   - 增加 `order` 字段（整数类型）
   - 更新 `to_dict()` 和 `from_dict()` 方法

2. **产品线服务** (`backend/services/productline_service.py`)
   - 增加排序逻辑：获取产品线时按 `order` 字段排序
   - 增加 `reorder_productlines()` 方法：批量更新产品线顺序
   - 修改 `create_productline()` 方法：新产品线自动分配最大order+1

3. **产品线路由** (`backend/routes/productlines.py`)
   - 新增API：`PUT /api/productlines/reorder`
   - 接收参数：`[{id: "pl-001", order: 0}, {id: "pl-002", order: 1}, ...]`

**前端修改**：

1. **安装依赖**
   - `@dnd-kit/core` - 拖拽核心库
   - `@dnd-kit/sortable` - 可排序列表
   - `@dnd-kit/utilities` - 工具函数

2. **产品线管理组件** (`frontend/src/components/ProductLineManagement.jsx`)
   - 集成拖拽排序功能
   - 拖拽完成后调用API保存排序
   - 显示拖拽手柄图标

3. **API服务** (`frontend/src/services/api.js`)
   - 新增 `reorderProductLines()` 方法

4. **时间轴视图** (`frontend/src/components/Timeline/TimelineView.jsx`)
   - 确保产品线按 `order` 字段排序显示

**数据迁移**：
- 启动时自动检查产品线数据
- 如果没有 `order` 字段，自动添加（按当前顺序：0, 1, 2, ...）
- 迁移逻辑放在 `productline_service.py` 中

## 三、验收标准

### 3.1 需求1：项目间隔显示

**功能验收**：
- [x] 所有项目块之间显示1天的视觉间隔
- [x] 项目块宽度计算正确（比实际时间跨度少1天）
- [x] 项目块位置计算正确（不影响整体布局）
- [x] 项目编辑时日期显示正确（实际日期）
- [x] 缩放功能正常工作（间隔随缩放比例调整）

**视觉验收**：
- [x] 项目块之间有明显的空隙
- [x] 空隙宽度约等于1天的宽度
- [x] 整体布局美观，不影响可读性

### 3.2 需求2：产品线排序

**功能验收**：
- [x] 产品线管理界面支持拖拽排序
- [x] 拖拽排序后自动保存到后端
- [x] 时间轴显示按排序顺序展示产品线
- [x] 新创建的产品线默认排在最后
- [x] 页面刷新后排序保持不变
- [x] 数据迁移成功（现有产品线自动添加order字段）

**交互验收**：
- [x] 拖拽操作流畅，有视觉反馈
- [x] 拖拽完成后立即生效
- [x] 排序变化在时间轴中实时反映

## 四、技术约束

### 4.1 兼容性约束

1. **现有数据兼容**
   - 必须支持没有 `order` 字段的旧数据
   - 自动迁移，不能丢失数据

2. **API兼容**
   - 新增API不能影响现有API
   - 现有API返回的产品线列表必须包含 `order` 字段

3. **前端兼容**
   - 拖拽功能不能影响现有的编辑、删除功能
   - 必须支持键盘操作（可访问性）

### 4.2 性能约束

1. **拖拽性能**
   - 拖拽操作必须流畅（60fps）
   - 产品线数量较多时（>50）不能卡顿

2. **API性能**
   - 排序API响应时间 < 500ms
   - 批量更新不能阻塞其他操作

### 4.3 代码规范约束

1. **代码质量**
   - 所有函数必须有中文注释
   - 遵循现有代码风格
   - 使用现有工具函数库

2. **错误处理**
   - 必须处理所有可能的错误情况
   - 提供友好的错误提示

## 五、风险评估与缓解

### 5.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 项目间隔影响现有布局 | 高 | 低 | 充分测试，只修改宽度计算 |
| 数据迁移失败 | 高 | 低 | 迁移前备份，使用事务 |
| 拖拽库兼容性问题 | 中 | 低 | 使用成熟的@dnd-kit库 |
| 排序API性能问题 | 中 | 低 | 批量更新，优化文件IO |

### 5.2 用户体验风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 间隔太大影响可读性 | 中 | 低 | 只减少1天，视觉效果适中 |
| 拖拽操作不流畅 | 中 | 低 | 使用高性能拖拽库 |
| 排序功能不易发现 | 低 | 中 | 在管理界面显著位置展示 |

## 六、开发计划

### 6.1 开发顺序

1. **阶段1：需求1 - 项目间隔显示**（优先级高，改动小）
   - 修改布局算法
   - 测试验证
   - 预计时间：2-3小时

2. **阶段2：需求2 - 产品线排序**（优先级中，改动较大）
   - 后端：模型、服务、API
   - 前端：安装依赖、拖拽功能
   - 数据迁移
   - 测试验证
   - 预计时间：4-5小时

### 6.2 测试计划

**单元测试**：
- 布局算法测试（宽度计算）
- 排序逻辑测试（order字段）
- 数据迁移测试

**集成测试**：
- 项目间隔显示测试
- 拖拽排序功能测试
- API调用测试

**用户验收测试**：
- 视觉效果验证
- 交互体验验证
- 性能验证

## 七、交付物清单

### 7.1 代码文件

**修改文件**：
- `frontend/src/utils/layoutUtils.js` - 布局算法
- `backend/models/productline.py` - 产品线模型
- `backend/services/productline_service.py` - 产品线服务
- `backend/routes/productlines.py` - 产品线路由
- `frontend/src/components/ProductLineManagement.jsx` - 产品线管理
- `frontend/src/services/api.js` - API服务
- `frontend/package.json` - 依赖配置

**新增文件**：
- 无（所有功能都是在现有文件基础上扩展）

### 7.2 文档文件

- `ALIGNMENT_项目间隔与产品线排序优化.md` - 需求对齐文档 ✅
- `CONSENSUS_项目间隔与产品线排序优化.md` - 需求共识文档 ✅
- `DESIGN_项目间隔与产品线排序优化.md` - 架构设计文档（待创建）
- `TASK_项目间隔与产品线排序优化.md` - 任务拆分文档（待创建）
- `ACCEPTANCE_项目间隔与产品线排序优化.md` - 验收文档（待创建）
- `FINAL_项目间隔与产品线排序优化.md` - 最终报告（待创建）

### 7.3 测试文件

- 单元测试用例
- 集成测试用例
- 用户验收测试清单

## 八、成功标准

### 8.1 功能完整性

- ✅ 所有需求功能都已实现
- ✅ 所有验收标准都已满足
- ✅ 所有测试用例都已通过

### 8.2 代码质量

- ✅ 代码符合项目规范
- ✅ 所有函数都有中文注释
- ✅ 没有引入技术债务

### 8.3 用户体验

- ✅ 视觉效果符合预期
- ✅ 交互流畅自然
- ✅ 性能满足要求

### 8.4 文档完整性

- ✅ 所有文档都已完成
- ✅ 文档内容准确完整
- ✅ 代码注释清晰易懂

## 九、下一步行动

1. ✅ 创建CONSENSUS文档（已完成）
2. ⏭️ 创建DESIGN文档（架构设计）
3. ⏭️ 创建TASK文档（任务拆分）
4. ⏭️ 进入Automate阶段（开始实施）

---

**文档状态**：✅ 已完成  
**用户确认**：✅ 已确认  
**准备进入下一阶段**：✅ 是
