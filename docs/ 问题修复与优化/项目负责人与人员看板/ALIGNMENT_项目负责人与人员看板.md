# ALIGNMENT - 项目负责人与人员看板

## 一、原始需求

### 用户需求描述
1. **项目增加产品负责人字段**，字段规则如下：
   - 单选
   - 必填
   - 增加单独人员配置项：
     - 支持新增与删除人员，如果已有项目已经关联某个人，则该人不允许删除
     - 每次新增人员时，自动为人员分配人员看板中显示的颜色

2. **新增一个看板，名称为「人员看板」**
   - 当前已有的看板名称为「进度」，支持用户切换「人员看板」或者「进度看板」
   - 人员看板的需求：不要按项目进度展示项目块颜色，而是按项目负责人展示项目块颜色，不同的项目负责人展示不同的颜色，其他与规则进度看板相同

## 二、项目上下文分析

### 2.1 现有项目架构

#### 技术栈
- **后端**: Python + Flask
- **前端**: React + Ant Design + Vite
- **数据存储**: JSON文件

#### 核心模块
1. **数据模型层** (`backend/models/`)
   - `project.py`: 项目模型，包含id、name、productLineId、startDate、endDate、status等字段
   - `productline.py`: 产品线模型
   - `settings.py`: 设置模型

2. **服务层** (`backend/services/`)
   - `project_service.py`: 项目CRUD操作
   - `productline_service.py`: 产品线CRUD操作
   - `settings_service.py`: 设置管理

3. **路由层** (`backend/routes/`)
   - `projects.py`: 项目API路由
   - `productlines.py`: 产品线API路由
   - `settings.py`: 设置API路由

4. **前端组件** (`frontend/src/components/`)
   - `ProjectModal.jsx`: 项目创建/编辑表单
   - `Timeline/TimelineView.jsx`: 时间轴主视图
   - `Timeline/ProjectBar.jsx`: 项目块组件
   - `ProductLineManagement.jsx`: 产品线管理
   - `ProductLineSettings.jsx`: 产品线显示设置

5. **工具函数** (`frontend/src/utils/`)
   - `constants.js`: 常量定义（包含STATUS_COLORS状态颜色映射）
   - `layoutUtils.js`: 布局算法
   - `dateUtils.js`: 日期工具

### 2.2 现有功能特性

#### 项目状态系统
- 7种状态：规划、方案、设计、开发、测试、已上、暂停
- 每种状态对应不同颜色（定义在`STATUS_COLORS`）
- 项目块根据状态显示不同颜色

#### 产品线系统
- 支持产品线的创建、删除
- 产品线作为项目的分组维度
- 产品线显示设置（可选择显示哪些产品线）

#### 时间轴看板
- 按产品线分组显示项目
- 项目块按状态显示颜色
- 支持时间范围设置
- 支持缩放控制

### 2.3 数据存储结构

#### 项目数据 (`data/projects.json`)
```json
{
  "id": "proj-uuid",
  "name": "项目名称",
  "productLineId": "pl-uuid",
  "startDate": "2025-01-01",
  "endDate": "2025-03-31",
  "status": "开发",
  "createdAt": 1704067200000,
  "updatedAt": 1704067200000
}
```

#### 产品线数据 (`data/productlines.json`)
```json
{
  "id": "pl-uuid",
  "name": "产品线名称",
  "createdAt": 1704067200000
}
```

#### 设置数据 (`data/settings.json`)
```json
{
  "visibleProductLines": ["pl-uuid-1", "pl-uuid-2"]
}
```

## 三、需求理解与边界确认

### 3.1 项目负责人字段

#### 功能需求
1. **数据模型扩展**
   - 项目模型需要新增`ownerId`字段（必填）
   - 需要创建人员（Owner）数据模型

2. **人员管理功能**
   - 需要独立的人员管理界面
   - 支持新增人员（输入姓名）
   - 支持删除人员（有关联项目的人员不可删除）
   - 每个人员自动分配唯一颜色

3. **项目表单集成**
   - ProjectModal需要新增"项目负责人"选择器
   - 必填验证
   - 单选模式

#### 技术约束
- 人员数据需要持久化存储（新增`data/owners.json`）
- 需要后端API支持人员CRUD
- 颜色分配需要算法（避免重复，视觉区分度高）

### 3.2 人员看板功能

#### 功能需求
1. **看板切换机制**
   - 当前看板：进度看板（按状态显示颜色）
   - 新增看板：人员看板（按负责人显示颜色）
   - 用户可以在两种看板间切换

2. **人员看板特性**
   - 项目块颜色由负责人决定（而非状态）
   - 不同负责人使用不同颜色
   - 其他显示规则与进度看板相同（时间轴、泳道、布局等）

3. **切换控制**
   - 需要UI控件（如Radio或Tab）
   - 切换状态需要持久化（localStorage或settings）

#### 技术实现
- 需要修改`ProjectBar.jsx`，根据看板类型选择颜色来源
- 需要在`TimelineView.jsx`或`App.jsx`添加切换控件
- 颜色映射需要从`STATUS_COLORS`扩展到`OWNER_COLORS`

### 3.3 颜色分配策略

#### 需求分析
- 人员数量不确定（可能很多）
- 需要自动分配颜色
- 颜色需要视觉区分度高
- 颜色需要持久化（同一人员始终同一颜色）

#### 技术方案
1. **预定义颜色池**
   - 准备一组高区分度的颜色（如20-30种）
   - 按顺序分配
   - 超出后可以使用算法生成

2. **颜色存储**
   - 人员模型包含`color`字段
   - 创建人员时自动分配
   - 颜色不可修改（保证一致性）

## 四、疑问澄清

### 4.1 人员管理界面位置
**问题**: 人员管理功能应该放在哪里？
**选项**:
1. 左侧设置面板（与产品线设置并列）
2. 独立的设置页面
3. 项目表单内的快捷入口

**建议**: 左侧设置面板，与产品线设置保持一致的交互模式

### 4.2 看板切换控件位置
**问题**: 看板切换控件应该放在哪里？
**选项**:
1. 时间轴顶部（与时间范围设置同一行）
2. 左侧设置面板顶部
3. 独立的工具栏

**建议**: 时间轴顶部右侧，使用Radio.Group或Segmented组件

### 4.3 默认看板类型
**问题**: 系统默认显示哪个看板？
**选项**:
1. 进度看板（保持现有行为）
2. 人员看板
3. 记住用户上次选择

**建议**: 默认进度看板，记住用户选择（localStorage）

### 4.4 人员删除限制提示
**问题**: 当用户尝试删除有关联项目的人员时，如何提示？
**选项**:
1. 禁用删除按钮，hover显示原因
2. 允许点击，弹出提示框说明原因
3. 显示关联的项目列表

**建议**: 禁用删除按钮 + hover提示 + 显示关联项目数量

### 4.5 颜色分配算法
**问题**: 如何确保颜色的视觉区分度？
**选项**:
1. 使用预定义的30种高对比度颜色
2. 使用HSL算法动态生成（色相均匀分布）
3. 混合方案（前20个预定义，后续动态生成）

**建议**: 混合方案，兼顾美观和扩展性

### 4.6 现有项目的负责人
**问题**: 现有项目没有负责人字段，如何处理？
**选项**:
1. 系统自动创建"未分配"人员，现有项目默认分配给他
2. 强制用户为现有项目分配负责人
3. 允许项目负责人为空（与需求矛盾）

**建议**: 创建"未分配"默认人员，现有项目自动关联，用户可后续修改

## 五、技术方案概要

### 5.1 后端改动
1. 新增`Owner`模型（`backend/models/owner.py`）
2. 新增`owner_service.py`服务层
3. 新增`owners.py`路由层
4. 修改`Project`模型，添加`ownerId`字段
5. 修改项目服务，支持负责人关联验证
6. 数据迁移脚本（为现有项目分配默认负责人）

### 5.2 前端改动
1. 新增`OwnerManagement.jsx`组件（人员管理）
2. 修改`ProjectModal.jsx`，添加负责人选择器
3. 修改`TimelineView.jsx`，添加看板切换控件
4. 修改`ProjectBar.jsx`，支持双色彩模式
5. 新增`OWNER_COLORS`常量定义
6. 新增人员相关API服务
7. 新增看板类型状态管理

### 5.3 数据文件
1. 新增`data/owners.json`
2. 修改`data/projects.json`结构（添加ownerId）
3. 可选：扩展`data/settings.json`（存储看板偏好）

## 六、验收标准

### 6.1 人员管理功能
- [ ] 可以新增人员（输入姓名）
- [ ] 新增人员时自动分配颜色
- [ ] 可以删除未关联项目的人员
- [ ] 不能删除已关联项目的人员（有明确提示）
- [ ] 人员列表显示关联项目数量
- [ ] 人员数据持久化

### 6.2 项目负责人字段
- [ ] 项目表单包含"项目负责人"选择器
- [ ] 负责人为必填项
- [ ] 负责人为单选模式
- [ ] 可以在表单内快速新增人员
- [ ] 项目数据包含ownerId字段
- [ ] 现有项目自动分配默认负责人

### 6.3 人员看板功能
- [ ] 可以切换"进度看板"和"人员看板"
- [ ] 人员看板中项目块按负责人显示颜色
- [ ] 不同负责人显示不同颜色
- [ ] 看板切换状态持久化
- [ ] 其他功能（时间轴、泳道、布局）与进度看板一致

### 6.4 颜色系统
- [ ] 每个人员有唯一颜色
- [ ] 颜色视觉区分度高
- [ ] 颜色持久化（同一人员始终同一颜色）
- [ ] 支持至少20个不同人员的颜色区分

### 6.5 用户体验
- [ ] 界面布局合理，不影响现有功能
- [ ] 操作流程顺畅
- [ ] 错误提示清晰
- [ ] 响应速度快

## 七、风险识别

### 7.1 数据迁移风险
- **风险**: 现有项目数据需要添加ownerId字段
- **影响**: 可能导致数据不一致
- **缓解**: 提供数据迁移脚本，自动为现有项目分配默认负责人

### 7.2 颜色冲突风险
- **风险**: 人员过多时颜色可能重复或难以区分
- **影响**: 用户体验下降
- **缓解**: 使用科学的颜色分配算法，支持至少30种颜色

### 7.3 性能风险
- **风险**: 人员数量增加可能影响渲染性能
- **影响**: 页面卡顿
- **缓解**: 使用React优化技术（memo、useMemo等）

### 7.4 兼容性风险
- **风险**: 新功能可能影响现有功能
- **影响**: 现有功能异常
- **缓解**: 充分测试，保持向后兼容

## 八、下一步行动

1. **等待用户确认**
   - 确认人员管理界面位置
   - 确认看板切换控件位置
   - 确认默认看板类型
   - 确认现有项目处理方案

2. **进入Architect阶段**
   - 详细设计数据模型
   - 设计API接口
   - 设计组件架构
   - 设计颜色分配算法

3. **准备开发**
   - 创建开发分支
   - 准备测试数据
   - 制定开发计划
