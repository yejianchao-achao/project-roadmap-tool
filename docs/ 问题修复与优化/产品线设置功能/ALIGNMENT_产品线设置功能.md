# 产品线设置功能 - 对齐文档

## 一、原始需求

去掉产品线筛选，而是增加一个产品线设置，可以设置页面上显示哪些产品线，该设置需要被保存下来，下次加载项目时仍然使用之前的配置。

## 二、项目上下文分析

### 2.1 现有项目架构
- **前端**: React + Vite + Ant Design
- **后端**: Python Flask
- **数据存储**: JSON文件 (data/productlines.json, data/projects.json)
- **技术栈**: 
  - 前端状态管理: React Hooks (useState, useEffect)
  - 后端服务层: Service层模式
  - 数据持久化: JSON文件读写

### 2.2 现有相关组件
1. **ProductLineFilter组件** (`frontend/src/components/ProductLineFilter.jsx`)
   - 当前功能: 实时筛选产品线，使用Checkbox.Group
   - 状态管理: 通过App.jsx的selectedProductLines状态
   - 特点: 每次刷新页面后重置，不保存配置

2. **App.jsx主组件**
   - 管理全局状态: projects, productLines, selectedProductLines
   - 数据加载: useEffect在组件挂载时加载数据
   - 当前问题: selectedProductLines初始化为空数组，无持久化

3. **后端数据结构**
   - productlines.json: 存储产品线列表
   - projects.json: 存储项目列表
   - 当前无用户配置存储机制

### 2.3 现有代码模式
- 前端API调用: 使用封装的api.js服务
- 后端路由: RESTful风格，使用装饰器处理异常
- 数据验证: 后端使用Model类进行数据验证
- 文件操作: 使用file_handler工具类统一处理

## 三、需求理解

### 3.1 功能变更
**从"筛选"改为"设置"的核心区别:**
- **筛选**: 临时性的、会话级的过滤，刷新后重置
- **设置**: 持久化的、用户级的配置，刷新后保持

### 3.2 具体要求
1. **UI层面**:
   - 将"产品线筛选"改名为"产品线设置"
   - 保持现有的Checkbox交互方式
   - 可能需要添加"保存设置"按钮或自动保存机制

2. **数据持久化**:
   - 需要存储用户选择的产品线配置
   - 页面刷新/重新打开时自动加载之前的配置
   - 配置应该是用户级的（当前项目为单用户系统）

3. **默认行为**:
   - 首次使用时的默认配置（全选？空选？）
   - 配置更新的时机（实时保存？手动保存？）

## 四、边界确认

### 4.1 明确的边界
- ✅ 单用户系统，无需考虑多用户配置隔离
- ✅ 配置存储在本地（JSON文件或localStorage）
- ✅ 只涉及产品线显示配置，不影响其他功能
- ✅ 保持现有的UI交互方式（Checkbox）

### 4.2 需要确认的边界
1. **配置存储位置**:
   - 选项A: 后端JSON文件（如 data/settings.json）
   - 选项B: 前端localStorage
   - 选项C: 混合方案

2. **保存时机**:
   - 选项A: 实时自动保存（每次勾选变化时）
   - 选项B: 手动保存（添加"保存设置"按钮）
   - 选项C: 延迟保存（防抖处理）

3. **默认配置**:
   - 选项A: 首次使用时全选所有产品线
   - 选项B: 首次使用时不选任何产品线
   - 选项C: 首次使用时显示配置引导

## 五、技术约束

### 5.1 现有系统约束
- 必须与现有的JSON文件存储方式兼容
- 必须保持现有的前后端API接口风格
- 必须使用现有的错误处理机制
- 必须保持现有的代码规范和注释风格

### 5.2 性能约束
- 配置加载应该在页面初始化时完成
- 配置保存不应阻塞UI交互
- 避免频繁的文件读写操作

## 六、疑问澄清

### 6.1 关键决策点

**问题1: 配置存储方案**
- 建议: 使用后端JSON文件存储（data/settings.json）
- 理由: 
  - 与现有架构一致
  - 便于备份和迁移
  - 可扩展性更好（未来可能添加其他设置）
- 需要确认: 是否接受此方案？

**问题2: 保存时机**
- 建议: 实时自动保存（每次勾选变化时）
- 理由:
  - 用户体验更好，无需额外操作
  - 符合"设置"的语义（设置即生效）
  - 避免用户忘记保存
- 需要确认: 是否接受此方案？

**问题3: 默认配置**
- 建议: 首次使用时全选所有产品线
- 理由:
  - 避免用户看到空白页面
  - 符合用户预期（显示所有内容）
  - 与当前行为一致（当前默认显示所有）
- 需要确认: 是否接受此方案？

**问题4: UI文案调整**
- 建议: 将"产品线筛选"改为"产品线显示设置"
- 理由:
  - 更准确地表达功能含义
  - 避免与"筛选"混淆
- 需要确认: 是否接受此文案？

## 七、实现方案概要

### 7.1 后端改动
1. 创建settings.json文件结构
2. 创建SettingsService服务类
3. 添加settings相关API路由
4. 实现配置的读取和保存

### 7.2 前端改动
1. 重命名ProductLineFilter为ProductLineSettings
2. 添加配置加载逻辑（页面初始化时）
3. 添加配置保存逻辑（选择变化时）
4. 更新API服务添加settings相关接口
5. 更新UI文案

### 7.3 数据结构设计
```json
{
  "settings": {
    "visibleProductLines": ["id1", "id2", "id3"]
  }
}
```

## 八、验收标准

1. ✅ 页面加载时自动应用之前保存的产品线配置
2. ✅ 用户勾选/取消勾选产品线时自动保存配置
3. ✅ 刷新页面后配置保持不变
4. ✅ 首次使用时默认显示所有产品线
5. ✅ UI文案从"筛选"改为"设置"
6. ✅ 不影响现有的项目显示和编辑功能
7. ✅ 配置文件格式正确，可读性好
8. ✅ 错误处理完善，配置加载失败时有合理的降级方案

## 九、风险评估

### 9.1 技术风险
- **低风险**: 配置存储机制简单，与现有架构一致
- **低风险**: UI改动较小，主要是逻辑调整
- **中风险**: 需要确保配置加载的时序正确（先加载配置，再加载项目数据）

### 9.2 用户体验风险
- **低风险**: 功能变更对用户透明，体验更好
- **低风险**: 保持现有交互方式，学习成本为零

## 十、后续扩展性

此次改动为未来的功能扩展奠定基础：
- 可以添加更多用户设置（如时间轴缩放比例、主题颜色等）
- 可以支持配置的导入导出
- 可以支持多用户配置（如果未来需要）
