# 需求对齐文档 - 时间范围设置功能

## 一、原始需求

用户可以手动设置时间轴展示范围，设置按钮左侧显示设置模块

## 二、项目上下文分析

### 2.1 现有项目架构
- **技术栈**: React 18.2.0 + Ant Design 5.12.0 + Vite
- **时间轴实现**: 基于dayjs的自定义时间轴组件
- **状态管理**: React Hooks (useState, useEffect)
- **样式方案**: CSS模块化

### 2.2 现有时间轴机制分析

#### 当前时间范围计算逻辑
位置: `frontend/src/utils/dateUtils.js` - `calculateTimelineParams()`

```javascript
// 基于当前月份计算全年时间范围
const now = dayjs()
const minDate = now.subtract(TIMELINE_TOTAL_MONTHS_BEFORE, 'month').startOf('month')
const maxDate = now.add(TIMELINE_TOTAL_MONTHS_AFTER, 'month').endOf('month')
```

**当前配置**:
- `TIMELINE_TOTAL_MONTHS_BEFORE = 6` (当前月之前6个月)
- `TIMELINE_TOTAL_MONTHS_AFTER = 5` (当前月之后5个月)
- **总时间范围**: 固定12个月 (6+1+5)

#### 当前缩放功能
位置: `frontend/src/components/Timeline/TimelineView.jsx`

**现有缩放控制**:
- 缩放按钮位置: 右上角 (`.timeline-zoom-controls`)
- 缩放范围: 2-12个月 (`MIN_VISIBLE_MONTHS` - `MAX_VISIBLE_MONTHS`)
- 缩放效果: 改变**视口显示的月份数**，不改变总时间范围
- 像素密度: 固定 5px/天 (`PIXELS_PER_DAY`)

**关键理解**:
- `visibleMonths`: 控制视口显示多少个月（已废弃，代码中未实际使用）
- `totalDays`: 基于固定的12个月计算
- `totalWidth`: 基于 `totalDays * pixelsPerDay` 计算

### 2.3 现有UI布局
```
┌─────────────────────────────────────────────────┐
│ [产品线筛选器]              [缩放控制] [新建项目] │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │         时间轴头部 (月份刻度)                │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │         时间轴内容 (项目泳道)                │ │
│ │                                             │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

**缩放控制位置**: `.timeline-zoom-controls`
- 位置: `position: absolute; top: 20px; right: 20px;`
- 包含: 缩小按钮、月份显示、放大按钮

## 三、需求理解与澄清

### 3.1 需求解读

**核心需求**: 允许用户手动设置时间轴的**总时间范围**（而非视口显示范围）

**关键点**:
1. **"时间轴展示范围"** 指的是时间轴的总时间跨度（minDate 到 maxDate）
2. **"设置按钮左侧显示设置模块"** 指在现有缩放按钮的左侧添加设置入口

### 3.2 功能边界确认

#### 需要实现的功能
1. ✅ 时间范围设置入口（按钮/图标）
2. ✅ 时间范围设置面板（弹窗/抽屉）
3. ✅ 开始日期选择器
4. ✅ 结束日期选择器
5. ✅ 应用设置功能
6. ✅ 重置为默认范围功能
7. ✅ 设置持久化（localStorage）

#### 不包含的功能
- ❌ 修改像素密度（保持5px/天）
- ❌ 修改视口缩放逻辑（保持现有缩放功能）
- ❌ 后端API存储设置（仅前端localStorage）

### 3.3 设计决策

#### 决策1: 设置面板形式
**选项**:
- A. Modal 弹窗
- B. Drawer 抽屉
- C. Popover 气泡卡片

**决策**: **Popover 气泡卡片**
**理由**:
- 轻量级，不遮挡主界面
- 符合Ant Design设计规范
- 适合简单的日期范围设置
- 与现有缩放控制在同一区域，交互一致

#### 决策2: 设置入口位置
**位置**: 缩放控制按钮的左侧
**布局**:
```
[设置图标] | [缩小] [4个月] [放大]
```

#### 决策3: 日期选择器类型
**选择**: Ant Design `DatePicker.RangePicker`
**理由**:
- 原生支持日期范围选择
- 自动处理开始/结束日期验证
- UI一致性好

#### 决策4: 默认时间范围
**保持现有逻辑**:
- 默认: 当前月前6个月 ~ 当前月后5个月（共12个月）
- 可通过"重置"按钮恢复默认

#### 决策5: 数据持久化
**方案**: localStorage
**存储键**: `timeline_date_range`
**数据格式**:
```json
{
  "startDate": "2025-04-01",
  "endDate": "2026-03-31",
  "isCustom": true
}
```

### 3.4 技术约束

1. **日期范围限制**:
   - 最小跨度: 1个月
   - 最大跨度: 无限制（但建议不超过5年，避免性能问题）
   - 开始日期必须 < 结束日期

2. **与现有功能的兼容性**:
   - 不影响现有缩放功能
   - 不影响项目数据加载
   - 不影响产品线筛选

3. **性能考虑**:
   - 时间范围过大时，需要优化渲染性能
   - 建议添加警告提示（如超过3年）

## 四、疑问澄清

### Q1: "设置按钮左侧"的具体位置？
**理解**: 在现有的缩放控制区域（右上角）的左侧添加设置图标
**确认**: 是否正确？

### Q2: 时间范围设置后，是否需要自动滚动到某个位置？
**建议**: 设置后自动滚动到新时间范围的起始位置
**确认**: 是否需要？

### Q3: 是否需要预设的快捷选项？
**建议**: 提供快捷选项（如"最近3个月"、"最近半年"、"最近一年"）
**确认**: 是否需要？

### Q4: 设置的时间范围是否需要与项目数据关联？
**理解**: 时间范围独立于项目数据，用户可以设置任意范围
**确认**: 是否正确？

### Q5: 是否需要在设置面板中显示当前项目的时间范围？
**建议**: 显示"项目时间范围: YYYY-MM-DD ~ YYYY-MM-DD"作为参考
**确认**: 是否需要？

## 五、验收标准（初步）

### 功能验收
1. ✅ 点击设置图标，弹出时间范围设置面板
2. ✅ 可以选择开始日期和结束日期
3. ✅ 日期验证正确（开始 < 结束，最小1个月）
4. ✅ 点击"应用"后，时间轴更新为新的时间范围
5. ✅ 点击"重置"后，恢复默认时间范围
6. ✅ 设置持久化，刷新页面后保持
7. ✅ 与现有缩放功能无冲突

### UI验收
1. ✅ 设置图标位于缩放控制左侧
2. ✅ 设置面板样式与项目整体风格一致
3. ✅ 日期选择器交互流畅
4. ✅ 响应式布局正常

### 性能验收
1. ✅ 时间范围变化后，渲染流畅（无明显卡顿）
2. ✅ 大时间范围（如3年）下，滚动流畅

## 六、下一步行动

1. 等待用户确认以上疑问
2. 基于确认结果，生成需求共识文档
3. 进入架构设计阶段
