# 项目间隔与产品线排序优化 - 需求对齐文档

## 一、原始需求

用户提出两个优化需求：

1. **项目间隔显示优化**：两个项目之间，默认显示间隔为 1 天，即如果前一个项目的结束时间+1=下一个项目的开始时间，则显示时，两个项目之间不是前后咬合，而是显示间隔一天的空隙

2. **产品线排序功能**：产品线增加排序功能，用户可以调整产品线的顺序（注：原文"孙旭"应为"顺序"的笔误）

## 二、项目上下文分析

### 2.1 现有项目架构

**技术栈**：
- 前端：React 18.2.0 + Ant Design 5.12.0 + Vite
- 后端：Flask 3.0.0 + Python 3.8+
- 数据存储：JSON文件

**核心组件**：
- `frontend/src/components/Timeline/` - 时间轴组件
  - `TimelineView.jsx` - 时间轴主视图
  - `ProjectBar.jsx` - 项目块组件
  - `Swimlane.jsx` - 产品线泳道
  - `TimelineGrid.jsx` - 时间轴网格
- `frontend/src/utils/layoutUtils.js` - 布局算法（项目位置计算）
- `frontend/src/utils/dateUtils.js` - 日期工具函数
- `backend/models/productline.py` - 产品线数据模型
- `backend/services/productline_service.py` - 产品线业务逻辑

**数据模型**：
```json
// productlines.json
{
  "productlines": [
    {
      "id": "pl-uuid-001",
      "name": "产品线名称",
      "createdAt": 1704067200000
    }
  ]
}

// projects.json
{
  "projects": [
    {
      "id": "proj-uuid-001",
      "name": "项目名称",
      "productLineId": "pl-uuid-001",
      "startDate": "2025-01-01",
      "endDate": "2025-03-31",
      "status": "开发"
    }
  ]
}
```

### 2.2 现有布局算法分析

根据项目文档，当前的项目块位置计算逻辑：
- 使用 `layoutUtils.js` 中的算法计算项目块位置
- 项目块宽度 = (结束日期 - 开始日期) × pixelsPerDay
- 项目块左偏移 = (开始日期 - 时间轴起始日期) × pixelsPerDay
- 当前算法：如果项目A结束日期 = 项目B开始日期，则两个项目块紧密相连

### 2.3 现有产品线显示逻辑

- 产品线在时间轴中按照数据文件中的顺序显示
- 没有排序字段，没有拖拽排序功能
- 产品线设置组件 `ProductLineSettings.jsx` 只负责显示/隐藏控制

## 三、需求理解与边界确认

### 3.1 需求1：项目间隔显示优化

**核心需求**：
- 当两个项目在时间上"紧密相连"（前一个项目结束日期 + 1天 = 后一个项目开始日期）时
- 在视觉上显示一个1天的间隔，而不是让两个项目块紧密咬合

**技术实现方向**：
- 修改项目块宽度计算逻辑：宽度 = (结束日期 - 开始日期 - 1) × pixelsPerDay
- 或者修改项目块左偏移计算：左偏移 = (开始日期 - 时间轴起始日期 + 0.5) × pixelsPerDay
- 需要确保间隔视觉效果明显但不影响整体布局

**边界问题**：
1. ❓ 间隔是否只在"紧密相连"的情况下显示？还是所有项目都默认显示间隔？
2. ❓ 间隔的视觉表现：是缩短项目块宽度？还是增加项目块之间的margin？
3. ❓ 间隔是否影响项目块的点击区域？
4. ❓ 是否需要在项目编辑时考虑这个间隔（例如，用户看到的日期和实际存储的日期是否一致）？

**我的理解与建议**：
- **建议方案**：修改项目块的视觉宽度，使其比实际时间跨度少1天
  - 项目块宽度 = (结束日期 - 开始日期) × pixelsPerDay - pixelsPerDay
  - 这样可以在所有项目块之间自然形成1天的视觉间隔
  - 不影响数据存储，只是视觉呈现的调整
  - 项目编辑时显示的日期仍然是实际的开始/结束日期

### 3.2 需求2：产品线排序功能

**核心需求**：
- 用户可以调整产品线在时间轴中的显示顺序
- 排序结果需要持久化保存

**技术实现方向**：
- 在产品线数据模型中增加 `order` 字段（整数，表示排序位置）
- 在产品线设置组件中增加拖拽排序功能（使用Ant Design的拖拽组件）
- 后端API支持更新产品线排序
- 前端显示时按 `order` 字段排序

**边界问题**：
1. ❓ 排序功能的交互方式：拖拽排序？上下箭头按钮？还是输入数字？
2. ❓ 新创建的产品线默认排序位置：放在最后？还是最前？
3. ❓ 排序是否影响产品线筛选的显示顺序？
4. ❓ 是否需要"重置排序"功能（恢复到默认顺序）？

**我的理解与建议**：
- **建议方案**：使用拖拽排序（最直观的交互方式）
  - 在 `ProductLineSettings.jsx` 组件中集成拖拽功能
  - 使用 Ant Design 的 `@dnd-kit/sortable` 或类似库
  - 拖拽完成后自动保存排序到后端
  - 新创建的产品线默认放在最后（order = 当前最大order + 1）
  - 排序同时影响时间轴显示和产品线设置列表

## 四、现有项目约束与集成方案

### 4.1 技术约束

1. **前端框架**：React 18 + Ant Design 5
2. **状态管理**：使用React Hooks（useState, useEffect）
3. **数据持久化**：后端JSON文件存储
4. **API规范**：RESTful API，Flask路由
5. **代码规范**：
   - 所有函数必须有中文注释
   - 遵循现有代码风格
   - 使用现有工具函数库

### 4.2 集成点分析

**需求1：项目间隔显示**
- 影响文件：
  - `frontend/src/utils/layoutUtils.js` - 修改项目块宽度计算
  - `frontend/src/components/Timeline/ProjectBar.jsx` - 可能需要调整样式
- 集成方式：修改现有布局算法，不影响其他功能

**需求2：产品线排序**
- 影响文件：
  - `backend/models/productline.py` - 增加order字段
  - `backend/services/productline_service.py` - 增加排序逻辑
  - `backend/routes/productlines.py` - 增加更新排序API
  - `frontend/src/components/ProductLineSettings.jsx` - 增加拖拽排序UI
  - `frontend/src/services/api.js` - 增加排序API调用
  - `data/productlines.json` - 数据迁移（增加order字段）
- 集成方式：扩展现有产品线管理功能

### 4.3 数据迁移策略

对于现有的产品线数据，需要：
1. 读取现有 `productlines.json`
2. 为每个产品线添加 `order` 字段（按当前顺序赋值：0, 1, 2, ...）
3. 保存更新后的数据

## 五、疑问澄清

### 5.1 需求1相关问题

**Q1**: 项目间隔是否只在"紧密相连"的情况下显示？还是所有项目都默认显示间隔？
- **我的建议**：所有项目块都显示1天的视觉间隔，这样视觉效果更统一

**Q2**: 间隔的视觉表现方式？
- **我的建议**：缩短项目块的视觉宽度（减去1天），保持项目块之间有明显的空隙

**Q3**: 是否影响项目编辑时的日期显示？
- **我的建议**：不影响，用户编辑时看到的仍然是实际的开始/结束日期

### 5.2 需求2相关问题

**Q4**: 排序功能的交互方式？
- **我的建议**：拖拽排序（最直观）

**Q5**: 新创建的产品线默认排序位置？
- **我的建议**：放在最后（order = 当前最大order + 1）

**Q6**: 是否需要"重置排序"功能？
- **我的建议**：暂不需要，用户可以手动拖拽调整

## 六、验收标准

### 6.1 需求1：项目间隔显示

**功能验收**：
- [ ] 所有项目块之间显示1天的视觉间隔
- [ ] 项目块宽度计算正确（比实际时间跨度少1天）
- [ ] 项目块位置计算正确（不影响整体布局）
- [ ] 项目编辑时日期显示正确（实际日期）
- [ ] 缩放功能正常工作（间隔随缩放比例调整）

**视觉验收**：
- [ ] 项目块之间有明显的空隙
- [ ] 空隙宽度约等于1天的宽度
- [ ] 整体布局美观，不影响可读性

### 6.2 需求2：产品线排序

**功能验收**：
- [ ] 产品线设置组件支持拖拽排序
- [ ] 拖拽排序后自动保存到后端
- [ ] 时间轴显示按排序顺序展示产品线
- [ ] 新创建的产品线默认排在最后
- [ ] 页面刷新后排序保持不变
- [ ] 数据迁移成功（现有产品线自动添加order字段）

**交互验收**：
- [ ] 拖拽操作流畅，有视觉反馈
- [ ] 拖拽完成后立即生效
- [ ] 排序变化在时间轴中实时反映

## 七、技术方案概要

### 7.1 需求1实现方案

**修改文件**：
- `frontend/src/utils/layoutUtils.js`

**核心逻辑**：
```javascript
// 修改项目块宽度计算
const projectWidth = (endDate - startDate) * pixelsPerDay - pixelsPerDay;
```

### 7.2 需求2实现方案

**后端修改**：
1. 产品线模型增加 `order` 字段
2. 产品线服务增加排序逻辑
3. 新增API：`PUT /api/productlines/reorder`

**前端修改**：
1. 安装拖拽库：`@dnd-kit/core` 和 `@dnd-kit/sortable`
2. `ProductLineSettings.jsx` 集成拖拽功能
3. API服务增加排序调用

**数据迁移**：
- 启动时自动检查并迁移数据

## 八、风险评估

### 8.1 技术风险

1. **项目间隔显示**：
   - 风险：可能影响现有的布局算法，导致项目块位置偏移
   - 缓解：充分测试，确保只影响宽度，不影响位置

2. **产品线排序**：
   - 风险：数据迁移可能失败，导致现有数据丢失
   - 缓解：迁移前备份数据，使用 `data_backup/` 目录

### 8.2 兼容性风险

1. **现有数据兼容**：
   - 风险：现有产品线数据没有order字段
   - 缓解：自动迁移，为现有数据添加order字段

2. **API兼容**：
   - 风险：新增API可能与现有API冲突
   - 缓解：使用新的路由路径，不影响现有API

## 九、开发计划

### 9.1 开发顺序

1. **需求1：项目间隔显示**（优先级高，改动小）
2. **需求2：产品线排序**（优先级中，改动较大）

### 9.2 预估工作量

- 需求1：2-3小时（修改布局算法 + 测试）
- 需求2：4-5小时（后端API + 前端拖拽 + 数据迁移 + 测试）
- 总计：6-8小时

## 十、下一步行动

1. **等待用户确认**：
   - 确认需求1的间隔显示方式
   - 确认需求2的排序交互方式
   - 确认验收标准

2. **进入Architect阶段**：
   - 创建详细的架构设计文档
   - 绘制系统架构图和数据流图

3. **进入Atomize阶段**：
   - 拆分为可执行的原子任务
   - 明确每个任务的输入输出契约
