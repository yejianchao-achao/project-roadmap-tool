# CONSENSUS - 项目负责人与人员看板

## 一、需求共识

### 1.1 核心需求确认

#### 需求1：项目负责人字段
- ✅ 项目模型新增`ownerId`字段（必填）
- ✅ 创建独立的人员（Owner）管理系统
- ✅ 人员管理界面位于左侧设置面板
- ✅ 支持新增/删除人员（有关联项目的不可删除）
- ✅ 新增人员时自动分配颜色
- ✅ 项目表单集成负责人选择器（必填、单选）

#### 需求2：人员看板
- ✅ 新增"人员看板"，与"进度看板"并存
- ✅ 看板切换控件位于时间轴顶部右侧（Segmented组件）
- ✅ 默认显示"进度看板"，记住用户选择
- ✅ 人员看板按负责人显示项目块颜色
- ✅ 其他功能与进度看板保持一致

### 1.2 技术方案确认

#### 数据模型
- ✅ 新增Owner模型（id、name、color、createdAt）
- ✅ Project模型添加ownerId字段
- ✅ 数据存储在`data/owners.json`

#### 颜色分配
- ✅ 混合方案：前20个预定义，后续HSL算法生成
- ✅ 颜色存储在Owner模型中
- ✅ 颜色不可修改（保证一致性）

#### 数据迁移
- ✅ 自动创建"未分配"默认人员
- ✅ 现有项目自动关联到默认人员
- ✅ 用户可后续修改项目负责人

#### 界面布局
- ✅ 人员管理：左侧设置面板
- ✅ 看板切换：时间轴顶部右侧
- ✅ 负责人选择：项目表单内

## 二、明确的需求描述

### 2.1 人员管理功能

#### 功能描述
用户可以在左侧设置面板中管理项目负责人列表。人员管理界面包含：
1. 人员列表展示（姓名、颜色标识、关联项目数）
2. 新增人员按钮和表单
3. 删除人员按钮（有关联项目的禁用）

#### 交互流程
1. 用户点击"新增人员"按钮
2. 输入人员姓名（必填，最多50字符）
3. 系统自动分配颜色
4. 保存后人员出现在列表中
5. 删除时检查关联项目，有关联则禁用并提示

#### 数据规则
- 人员姓名不能重复
- 人员姓名不能为空
- 每个人员有唯一ID和颜色
- 删除人员需要检查项目关联

### 2.2 项目负责人字段

#### 功能描述
项目创建/编辑表单中新增"项目负责人"选择器，用户必须为项目指定一个负责人。

#### 交互流程
1. 打开项目表单
2. 选择负责人（下拉选择器）
3. 可选：在下拉框内快速新增人员
4. 保存时验证负责人必填
5. 项目数据包含ownerId字段

#### 数据规则
- 负责人为必填项
- 负责人为单选模式
- 负责人必须是已存在的人员
- 现有项目默认关联"未分配"人员

### 2.3 人员看板功能

#### 功能描述
在时间轴顶部提供看板类型切换控件，用户可以在"进度看板"和"人员看板"之间切换。

#### 交互流程
1. 用户点击看板切换控件（Segmented组件）
2. 选择"进度看板"或"人员看板"
3. 项目块颜色立即更新
4. 选择状态保存到localStorage
5. 下次打开自动恢复上次选择

#### 显示规则
- **进度看板**：项目块按状态显示颜色（现有逻辑）
- **人员看板**：项目块按负责人显示颜色（新逻辑）
- 其他功能保持一致：时间轴、泳道、布局、筛选等

### 2.4 颜色分配系统

#### 功能描述
系统自动为每个人员分配唯一的颜色，确保视觉区分度高。

#### 分配规则
1. **前20个人员**：使用预定义的20种高对比度颜色
2. **第21个及以后**：使用HSL算法生成（色相均匀分布）
3. 颜色一旦分配不可修改
4. 颜色存储在人员数据中

#### 预定义颜色池（20种）
```javascript
[
  '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
  '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
  '#E74C3C', '#3498DB', '#9B59B6', '#1ABC9C', '#F39C12',
  '#E67E22', '#95A5A6', '#34495E', '#16A085', '#27AE60'
]
```

## 三、技术实现方案

### 3.1 后端架构

#### 数据模型（backend/models/owner.py）
```python
class Owner:
    id: str              # 人员唯一标识（owner-uuid）
    name: str            # 人员姓名（必填，最多50字符）
    color: str           # 分配的颜色（HEX格式）
    createdAt: int       # 创建时间戳
```

#### 服务层（backend/services/owner_service.py）
- `get_all_owners()`: 获取所有人员
- `get_owner_by_id(owner_id)`: 获取单个人员
- `create_owner(name)`: 创建人员（自动分配颜色）
- `delete_owner(owner_id)`: 删除人员（检查项目关联）
- `get_owner_project_count(owner_id)`: 获取人员关联项目数
- `assign_color()`: 颜色分配算法

#### 路由层（backend/routes/owners.py）
- `GET /api/owners`: 获取所有人员
- `POST /api/owners`: 创建人员
- `DELETE /api/owners/:id`: 删除人员
- `GET /api/owners/:id/projects/count`: 获取关联项目数

#### 项目模型修改（backend/models/project.py）
```python
class Project:
    # 现有字段...
    ownerId: str         # 新增：项目负责人ID（必填）
```

#### 数据迁移（backend/utils/migrate_owners.py）
- 检查现有项目是否有ownerId
- 创建"未分配"默认人员
- 为现有项目添加ownerId字段

### 3.2 前端架构

#### 组件结构
```
frontend/src/components/
├── OwnerManagement.jsx          # 新增：人员管理组件
├── ProjectModal.jsx             # 修改：添加负责人选择器
├── Timeline/
│   ├── TimelineView.jsx         # 修改：添加看板切换控件
│   └── ProjectBar.jsx           # 修改：支持双色彩模式
```

#### 状态管理
```javascript
// App.jsx 或 TimelineView.jsx
const [boardType, setBoardType] = useState('status') // 'status' | 'owner'
const [owners, setOwners] = useState([])
```

#### 常量定义（frontend/src/utils/constants.js）
```javascript
// 新增：人员颜色池
export const OWNER_COLOR_POOL = [
  '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
  // ... 20种颜色
]

// 新增：看板类型
export const BOARD_TYPES = {
  STATUS: 'status',   // 进度看板
  OWNER: 'owner'      // 人员看板
}
```

#### API服务（frontend/src/services/api.js）
```javascript
// 新增人员相关API
export const getOwners = () => { /* ... */ }
export const createOwner = (name) => { /* ... */ }
export const deleteOwner = (ownerId) => { /* ... */ }
export const getOwnerProjectCount = (ownerId) => { /* ... */ }
```

### 3.3 数据存储

#### owners.json
```json
{
  "owners": [
    {
      "id": "owner-default",
      "name": "未分配",
      "color": "#95A5A6",
      "createdAt": 1704067200000
    },
    {
      "id": "owner-uuid-001",
      "name": "张三",
      "color": "#FF6B6B",
      "createdAt": 1704067200000
    }
  ]
}
```

#### projects.json（修改）
```json
{
  "id": "proj-uuid",
  "name": "项目名称",
  "productLineId": "pl-uuid",
  "ownerId": "owner-uuid-001",  // 新增字段
  "startDate": "2025-01-01",
  "endDate": "2025-03-31",
  "status": "开发",
  "createdAt": 1704067200000,
  "updatedAt": 1704067200000
}
```

#### settings.json（可选扩展）
```json
{
  "visibleProductLines": ["pl-uuid-1"],
  "boardType": "status"  // 可选：存储看板偏好
}
```

## 四、验收标准

### 4.1 功能验收

#### 人员管理
- [ ] 可以查看所有人员列表
- [ ] 可以新增人员（输入姓名）
- [ ] 新增人员时自动分配颜色
- [ ] 可以删除未关联项目的人员
- [ ] 不能删除已关联项目的人员
- [ ] 删除按钮禁用时显示提示信息
- [ ] 人员列表显示关联项目数量
- [ ] 人员姓名不能重复
- [ ] 人员姓名不能为空

#### 项目负责人
- [ ] 项目表单包含"项目负责人"选择器
- [ ] 负责人为必填项（有验证提示）
- [ ] 负责人为单选模式
- [ ] 可以在表单内快速新增人员
- [ ] 新建项目时必须选择负责人
- [ ] 编辑项目时可以修改负责人
- [ ] 项目数据正确保存ownerId

#### 人员看板
- [ ] 时间轴顶部显示看板切换控件
- [ ] 可以切换"进度看板"和"人员看板"
- [ ] 进度看板按状态显示颜色（现有逻辑）
- [ ] 人员看板按负责人显示颜色
- [ ] 不同负责人显示不同颜色
- [ ] 看板切换立即生效
- [ ] 看板选择持久化（刷新后保持）
- [ ] 其他功能不受影响（时间轴、泳道、布局等）

#### 数据迁移
- [ ] 系统自动创建"未分配"默认人员
- [ ] 现有项目自动关联到默认人员
- [ ] 用户可以修改现有项目的负责人
- [ ] 数据迁移不影响现有功能

### 4.2 技术验收

#### 后端
- [ ] Owner模型定义正确
- [ ] 人员CRUD API正常工作
- [ ] 颜色分配算法正确
- [ ] 删除人员时正确检查项目关联
- [ ] Project模型包含ownerId字段
- [ ] 项目创建/更新时验证ownerId
- [ ] 数据持久化正常

#### 前端
- [ ] OwnerManagement组件正常渲染
- [ ] 人员列表正确显示
- [ ] 新增/删除人员交互流畅
- [ ] ProjectModal正确集成负责人选择器
- [ ] 看板切换控件正常工作
- [ ] ProjectBar根据看板类型显示正确颜色
- [ ] 状态管理正确
- [ ] API调用正常

#### 用户体验
- [ ] 界面布局合理美观
- [ ] 操作流程顺畅直观
- [ ] 错误提示清晰友好
- [ ] 响应速度快
- [ ] 无明显bug
- [ ] 兼容现有功能

## 五、边界与限制

### 5.1 功能边界
- ✅ 支持人员的新增和删除
- ✅ 支持项目负责人的选择和修改
- ✅ 支持两种看板类型切换
- ❌ 不支持人员信息的编辑（姓名、颜色）
- ❌ 不支持人员的排序或分组
- ❌ 不支持多负责人（仅单选）
- ❌ 不支持负责人权限管理

### 5.2 技术约束
- 人员数量建议不超过100个（颜色区分度考虑）
- 人员姓名最多50个字符
- 颜色使用HEX格式
- 数据存储在JSON文件中
- 前端使用localStorage存储看板偏好

### 5.3 兼容性要求
- 不影响现有项目功能
- 不影响现有产品线功能
- 不影响现有时间轴功能
- 数据迁移平滑无感知
- 向后兼容

## 六、集成方案

### 6.1 与现有系统集成

#### 产品线系统
- 人员管理与产品线管理并列
- 两者独立，互不影响
- 共享左侧设置面板空间

#### 项目系统
- 项目模型扩展ownerId字段
- 项目表单集成负责人选择器
- 项目列表/详情显示负责人信息

#### 时间轴系统
- 时间轴顶部添加看板切换控件
- ProjectBar支持双色彩模式
- 布局算法保持不变

### 6.2 数据流

#### 创建项目流程
```
用户填写表单 → 选择负责人 → 提交 → 
后端验证ownerId → 保存项目 → 返回成功 → 
前端刷新列表 → 时间轴更新
```

#### 创建人员流程
```
用户输入姓名 → 提交 → 后端分配颜色 → 
保存人员 → 返回成功 → 前端刷新列表 → 
项目表单选择器更新
```

#### 切换看板流程
```
用户点击切换控件 → 更新状态 → 
保存到localStorage → ProjectBar重新渲染 → 
颜色立即更新
```

## 七、下一步行动

### 7.1 进入Architect阶段
- ✅ 需求已明确
- ✅ 技术方案已确认
- ✅ 验收标准已定义
- ➡️ 准备详细架构设计

### 7.2 准备工作
- 创建开发分支
- 准备测试数据
- 设计数据库迁移脚本
- 准备UI原型（可选）

### 7.3 风险管理
- 数据迁移测试
- 性能测试（大量人员场景）
- 兼容性测试
- 用户体验测试
