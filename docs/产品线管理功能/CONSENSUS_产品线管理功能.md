# 产品线管理功能 - 需求共识文档

## 一、需求确认

### 1.1 原始需求
```
# 当前问题：产品线只能新增，不能删除
# 期望：增加统一的产品线管理功能,功能需求如下：
1. 可以新增或者删除产品线
2. 可以设置哪些产品线不显示（只是不在看板显示对应产品线泳道，但是创建项目的时候仍然可以选择）
```

### 1.2 关键决策确认

#### 决策1: 删除策略 ✅ 已确认
**选择**: 禁止删除有关联项目的产品线，提示用户先处理

**实现细节**:
- 删除前检查是否有项目关联该产品线
- 如果有关联项目，返回403错误，并提示关联的项目数量
- 用户需要先删除或迁移关联项目，才能删除产品线
- 提供清晰的错误信息，告知用户具体有多少个项目关联

#### 决策2: 编辑功能 ✅ 已确认
**选择**: 需要支持编辑产品线名称

**实现细节**:
- 提供编辑产品线名称的功能
- 编辑时验证名称不为空且不重复
- 编辑后自动更新所有引用（项目数据中的productLineId保持不变）

## 二、最终需求规范

### 2.1 功能需求

#### F1: 产品线管理界面
**描述**: 提供统一的产品线管理入口和界面

**功能点**:
1. 在ProductLineSettings组件顶部增加"管理产品线"按钮
2. 点击后打开侧边抽屉（Drawer）
3. 抽屉中展示产品线列表（表格形式）
4. 表格列：名称、创建时间、关联项目数、操作按钮

#### F2: 新建产品线
**描述**: 在管理界面中新建产品线

**功能点**:
1. 抽屉顶部提供"新建产品线"按钮
2. 点击后显示表单（可以是内联表单或模态框）
3. 输入产品线名称（必填，最多100字符）
4. 验证名称不重复
5. 创建成功后刷新列表

#### F3: 编辑产品线
**描述**: 编辑产品线名称

**功能点**:
1. 每行提供"编辑"按钮
2. 点击后进入编辑模式（行内编辑或模态框）
3. 修改产品线名称
4. 验证名称不为空且不重复
5. 保存后刷新列表

#### F4: 删除产品线
**描述**: 删除产品线（带关联检查）

**功能点**:
1. 每行提供"删除"按钮
2. 点击后显示确认对话框
3. 后端检查是否有项目关联
4. 如果有关联项目：
   - 返回403错误
   - 提示"该产品线有X个关联项目，请先删除或迁移这些项目"
   - 不执行删除操作
5. 如果无关联项目：
   - 执行删除
   - 显示成功提示
   - 刷新列表

#### F5: 显示/隐藏切换
**描述**: 快速切换产品线在看板中的显示状态

**功能点**:
1. 每行提供"显示/隐藏"开关
2. 切换后立即保存到settings
3. 实时更新看板显示
4. 不影响项目创建时的产品线选择

#### F6: 关联信息展示
**描述**: 显示每个产品线的关联项目数量

**功能点**:
1. 表格中显示"关联项目数"列
2. 实时统计每个产品线关联的项目数量
3. 点击数量可以查看关联的项目列表（可选功能）

### 2.2 技术实现方案

#### 后端API设计

**API 1: 更新产品线**
```
PUT /api/productlines/:id
Content-Type: application/json

Request Body:
{
  "name": "新产品线名称"
}

Response (成功):
{
  "success": true,
  "data": {
    "id": "pl-uuid-001",
    "name": "新产品线名称",
    "createdAt": 1704067200000
  }
}

Response (失败 - 名称重复):
{
  "success": false,
  "error": "产品线名称已存在: 新产品线名称"
}
```

**API 2: 删除产品线**
```
DELETE /api/productlines/:id

Response (成功):
{
  "success": true,
  "message": "产品线删除成功"
}

Response (失败 - 有关联项目):
{
  "success": false,
  "error": "该产品线有3个关联项目，请先删除或迁移这些项目",
  "relatedProjectsCount": 3
}

Response (失败 - 不存在):
{
  "success": false,
  "error": "产品线不存在"
}
```

#### 前端组件设计

**组件1: ProductLineManagement.jsx**
- 侧边抽屉组件
- 包含产品线列表表格
- 包含新建/编辑/删除操作
- 包含显示/隐藏开关

**组件2: ProductLineSettings.jsx（修改）**
- 增加"管理产品线"按钮
- 保持现有的显示设置功能

**组件3: App.jsx（修改）**
- 集成ProductLineManagement组件
- 管理抽屉打开/关闭状态
- 处理数据刷新

### 2.3 UI/UX设计

#### 布局设计
```
ProductLineSettings (左侧面板)
├── [管理产品线] 按钮 ← 新增
├── 显示设置
│   ├── 全选 (X/Y)
│   └── 产品线复选框列表
└── 状态图例

ProductLineManagement (侧边抽屉)
├── 标题: "产品线管理"
├── [新建产品线] 按钮
└── 产品线列表表格
    ├── 列: 名称
    ├── 列: 创建时间
    ├── 列: 关联项目数
    ├── 列: 显示状态 (开关)
    └── 列: 操作 (编辑/删除)
```

#### 交互流程

**新建流程**:
1. 点击"新建产品线"按钮
2. 显示输入框（行内或模态框）
3. 输入名称
4. 点击"确定"
5. 验证通过 → 创建成功 → 刷新列表 → 显示成功提示
6. 验证失败 → 显示错误提示

**编辑流程**:
1. 点击"编辑"按钮
2. 进入编辑模式
3. 修改名称
4. 点击"保存"
5. 验证通过 → 更新成功 → 刷新列表 → 显示成功提示
6. 验证失败 → 显示错误提示

**删除流程**:
1. 点击"删除"按钮
2. 显示确认对话框："确定要删除产品线"XXX"吗？"
3. 点击"确定"
4. 后端检查关联项目
5. 有关联 → 显示错误提示："该产品线有X个关联项目，请先删除或迁移这些项目"
6. 无关联 → 删除成功 → 刷新列表 → 显示成功提示

**显示/隐藏切换流程**:
1. 点击开关
2. 立即更新UI状态
3. 异步保存到settings
4. 实时更新看板显示

### 2.4 数据流设计

```
用户操作 → 前端组件 → API调用 → 后端服务 → 数据文件
                ↓
            状态更新
                ↓
            UI刷新
```

**数据刷新策略**:
- 所有操作（新建/编辑/删除）成功后，重新加载产品线列表
- 显示/隐藏切换后，立即更新本地状态，异步保存到后端
- 使用乐观更新策略，提升用户体验

## 三、技术约束

### 3.1 技术栈约束
- 前端: React 18.2.0 + Ant Design 5.12.0
- 后端: Flask 3.0.0
- 数据存储: JSON文件
- API风格: RESTful

### 3.2 代码规范约束
- 所有代码必须包含完整的中文注释
- 函数必须包含功能描述、参数说明、返回值说明
- 遵循现有项目的代码风格
- 复用现有组件和工具函数

### 3.3 兼容性约束
- 必须与现有功能兼容
- 不能破坏现有的产品线显示设置功能
- 不能影响项目创建时的产品线选择

### 3.4 性能约束
- 操作响应时间 < 500ms
- 列表加载时间 < 1s
- 支持至少100个产品线的管理

## 四、验收标准

### 4.1 功能验收标准

#### 后端API验收
- [x] PUT /api/productlines/:id 正常工作
- [x] DELETE /api/productlines/:id 正常工作
- [x] 删除时正确检查项目关联
- [x] 有关联项目时返回403错误和清晰提示
- [x] 无关联项目时成功删除
- [x] 编辑时正确验证数据（名称不为空、不重复）
- [x] 所有API返回统一格式的响应

#### 前端功能验收
- [x] 可以打开产品线管理抽屉
- [x] 可以查看所有产品线列表
- [x] 可以看到每个产品线的关联项目数
- [x] 可以新建产品线
- [x] 可以编辑产品线名称
- [x] 可以删除产品线（无关联项目时）
- [x] 删除有关联项目的产品线时显示错误提示
- [x] 可以快速切换产品线显示/隐藏
- [x] 所有操作后数据实时刷新
- [x] 所有操作有明确的成功/失败反馈

### 4.2 用户体验验收标准
- [x] 操作流程顺畅，无卡顿
- [x] 错误提示清晰易懂
- [x] 确认对话框提示明确
- [x] 抽屉打开/关闭动画流畅
- [x] 响应式布局适配良好
- [x] 表格数据展示清晰

### 4.3 代码质量验收标准
- [x] 所有代码包含完整注释
- [x] 代码风格与现有项目一致
- [x] 复用现有组件和工具函数
- [x] 无console.log等调试代码
- [x] 异常处理完整
- [x] 变量命名清晰

### 4.4 数据完整性验收标准
- [x] 删除操作不会导致数据不一致
- [x] 编辑操作正确更新数据
- [x] 文件锁机制正常工作
- [x] 并发操作不会导致数据损坏
- [x] 关联检查准确无误

## 五、风险评估

### 5.1 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 文件并发写入冲突 | 中 | 低 | 使用现有的文件锁机制 |
| 关联检查性能问题 | 低 | 低 | 项目数量有限，性能可接受 |
| 前端状态同步问题 | 中 | 中 | 使用统一的数据刷新策略 |

### 5.2 业务风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 用户误删产品线 | 高 | 中 | 删除前显示确认对话框 |
| 编辑名称导致混淆 | 低 | 低 | 提供清晰的编辑界面 |
| 显示设置丢失 | 中 | 低 | 使用后端持久化存储 |

## 六、实施计划

### 6.1 开发阶段
1. **后端开发** (预计2小时)
   - 实现PUT /api/productlines/:id
   - 实现DELETE /api/productlines/:id
   - 增强关联检查逻辑

2. **前端开发** (预计3小时)
   - 创建ProductLineManagement组件
   - 修改ProductLineSettings组件
   - 集成到App.jsx

3. **测试验证** (预计1小时)
   - 功能测试
   - 边界测试
   - 集成测试

### 6.2 里程碑
- M1: 后端API开发完成
- M2: 前端组件开发完成
- M3: 集成测试通过
- M4: 功能交付

## 七、成功标准

### 7.1 必须满足（Must Have）
- ✅ 可以新建产品线
- ✅ 可以编辑产品线名称
- ✅ 可以删除产品线（带关联检查）
- ✅ 可以切换产品线显示/隐藏
- ✅ 显示关联项目数量
- ✅ 所有操作有明确反馈

### 7.2 应该满足（Should Have）
- ✅ 操作流程顺畅
- ✅ 错误提示清晰
- ✅ 界面美观易用
- ✅ 响应式布局

### 7.3 可以满足（Could Have）
- ⭕ 点击关联项目数查看项目列表
- ⭕ 产品线排序功能
- ⭕ 批量操作

### 7.4 暂不满足（Won't Have）
- ❌ 产品线分组/分类
- ❌ 产品线权限管理
- ❌ 产品线导入/导出
- ❌ 产品线历史记录

## 八、下一步行动

1. ✅ 需求共识已达成
2. ➡️ 进入Architect阶段 - 创建详细设计文档
3. ➡️ 进入Atomize阶段 - 拆分原子任务
4. ➡️ 进入Approve阶段 - 人工审批
5. ➡️ 进入Automate阶段 - 开始实施
6. ➡️ 进入Assess阶段 - 质量评估

---

**文档版本**: v1.0  
**创建时间**: 2025-10-16  
**状态**: ✅ 已确认，可以进入下一阶段
