# 产品线管理功能 - 需求对齐文档

## 一、原始需求

### 用户描述
```
# 当前问题：产品线只能新增，不能删除
# 期望：增加统一的产品线管理功能,功能需求如下：
1. 可以新增或者删除产品线
2. 可以设置哪些产品线不显示（只是不在看板显示对应产品线泳道，但是创建项目的时候仍然可以选择）
```

## 二、项目上下文分析

### 2.1 现有项目架构
- **技术栈**: React + Ant Design + Flask
- **数据存储**: JSON文件（data/productlines.json, data/projects.json）
- **架构模式**: 前后端分离，RESTful API

### 2.2 现有产品线功能分析

#### 后端现状
1. **数据模型** (`backend/models/productline.py`)
   - 已有ProductLine类，包含id、name、createdAt字段
   - 已有数据验证逻辑
   - 支持to_dict和from_dict转换

2. **服务层** (`backend/services/productline_service.py`)
   - ✅ 已实现：get_all(), get_by_id(), create()
   - ✅ 已实现：delete() 方法（但未暴露API）
   - ❌ 缺失：批量操作、关联检查

3. **路由层** (`backend/routes/productlines.py`)
   - ✅ 已实现：GET /api/productlines（获取列表）
   - ✅ 已实现：POST /api/productlines（创建）
   - ❌ 缺失：DELETE /api/productlines/:id（删除）
   - ❌ 缺失：PUT /api/productlines/:id（更新）

4. **设置管理** (`backend/models/settings.py`, `backend/routes/settings.py`)
   - ✅ 已实现：visibleProductLines设置（控制显示）
   - ✅ 已实现：GET/PUT/POST settings API

#### 前端现状
1. **组件结构**
   - `ProductLineSettings.jsx`: 显示设置组件（仅控制显示/隐藏）
   - `ProjectModal.jsx`: 项目表单（包含产品线选择和新建）
   - `App.jsx`: 主应用（管理状态和数据流）

2. **现有功能**
   - ✅ 产品线显示/隐藏切换（通过ProductLineSettings）
   - ✅ 创建项目时新建产品线（在ProjectModal中）
   - ❌ 缺失：统一的产品线管理界面
   - ❌ 缺失：删除产品线功能
   - ❌ 缺失：编辑产品线功能

### 2.3 数据关联分析
- **项目依赖产品线**: 每个项目必须关联一个产品线（productLineId字段）
- **删除风险**: 删除产品线可能导致关联项目数据不一致
- **显示控制**: visibleProductLines设置仅控制UI显示，不影响数据

## 三、需求理解与澄清

### 3.1 功能需求拆解

#### 需求1: 可以新增或者删除产品线
**理解**：
- 新增功能已存在（在ProjectModal中），但需要统一管理入口
- 删除功能需要新增，包括：
  - 后端API（已有service方法，需暴露路由）
  - 前端UI（删除按钮、确认对话框）
  - 关联检查（有项目关联时的处理策略）

**澄清问题**：
1. ❓ 删除产品线时，如果有项目关联该产品线，应该如何处理？
   - 选项A: 禁止删除，提示用户先删除或迁移关联项目
   - 选项B: 允许删除，但保留项目数据（项目的productLineId变为无效引用）
   - 选项C: 级联删除，同时删除所有关联项目
   - **推荐**: 选项A（最安全，符合数据完整性原则）

2. ❓ 是否需要编辑产品线名称的功能？
   - 虽然需求未明确提及，但作为完整的管理功能应该包含
   - **推荐**: 增加编辑功能

#### 需求2: 可以设置哪些产品线不显示
**理解**：
- 此功能已实现（ProductLineSettings组件 + visibleProductLines设置）
- 不显示 = 在时间轴看板中隐藏对应泳道
- 创建项目时仍可选择 = 在ProjectModal的下拉列表中仍然显示

**确认**：
- ✅ 现有实现已满足需求
- ✅ 需要在新的管理界面中保留此功能

### 3.2 技术实现方案

#### 方案选择
**选项1: 独立管理页面**
- 优点: 功能集中，操作流畅
- 缺点: 需要路由管理，增加复杂度

**选项2: 模态对话框管理**
- 优点: 实现简单，与现有架构一致
- 缺点: 空间有限，复杂操作体验较差

**选项3: 侧边抽屉管理**
- 优点: 空间充足，不离开当前页面，操作便捷
- 缺点: 需要新增Drawer组件

**推荐方案**: 选项3（侧边抽屉）
- 符合Ant Design设计规范
- 与现有ProductLineSettings组件位置接近，用户体验好
- 可以展示完整的产品线列表和操作按钮

### 3.3 UI/UX设计

#### 入口设计
- 在ProductLineSettings组件顶部增加"管理产品线"按钮
- 点击后打开侧边抽屉

#### 抽屉内容
1. **产品线列表**
   - 表格形式展示：名称、创建时间、关联项目数、操作
   - 支持搜索/筛选

2. **操作按钮**
   - 新建：打开新建表单
   - 编辑：打开编辑表单（行内操作）
   - 删除：确认对话框（行内操作）
   - 显示/隐藏：快捷切换（行内操作）

3. **关联信息**
   - 显示每个产品线关联的项目数量
   - 删除时如有关联项目，显示警告信息

## 四、边界确认

### 4.1 任务范围（IN SCOPE）
✅ 后端API开发
- 新增DELETE /api/productlines/:id
- 新增PUT /api/productlines/:id
- 增强删除逻辑（关联检查）

✅ 前端组件开发
- 新增ProductLineManagement组件（抽屉）
- 修改ProductLineSettings组件（增加管理入口）
- 集成到App.jsx

✅ 数据完整性
- 删除前检查项目关联
- 提供清晰的错误提示

✅ 用户体验
- 确认对话框
- 操作反馈（成功/失败提示）
- 实时数据刷新

### 4.2 任务边界（OUT OF SCOPE）
❌ 产品线排序功能
❌ 产品线分组/分类
❌ 产品线权限管理
❌ 产品线导入/导出
❌ 产品线历史记录
❌ 批量操作（批量删除、批量显示/隐藏）

### 4.3 技术约束
- 必须使用现有技术栈（React + Ant Design + Flask）
- 必须保持与现有代码风格一致
- 必须复用现有组件和工具函数
- 数据存储仍使用JSON文件
- API设计遵循RESTful规范

### 4.4 质量要求
- 所有代码必须包含完整注释
- 必须处理所有异常情况
- 必须提供用户友好的错误提示
- 必须保证数据一致性
- 必须通过手动测试验证

## 五、疑问与假设

### 5.1 需要确认的问题

#### 问题1: 删除策略 ⚠️ 关键决策
**问题**: 删除产品线时，如果有项目关联该产品线，应该如何处理？

**选项**:
- A. 禁止删除，提示用户先处理关联项目（推荐）
- B. 允许删除，项目保留但productLineId失效
- C. 级联删除所有关联项目

**影响**: 直接影响删除逻辑的实现和用户体验

**推荐**: 选项A
**理由**:
1. 数据完整性最高
2. 避免误操作导致数据丢失
3. 符合用户预期（删除前需要清理依赖）

#### 问题2: 是否需要编辑功能
**问题**: 是否需要支持编辑产品线名称？

**分析**:
- 需求未明确提及
- 但作为完整的管理功能应该包含
- 实现成本低

**推荐**: 增加编辑功能
**理由**: 提供完整的CRUD能力，提升用户体验

### 5.2 假设条件

基于项目现状和行业最佳实践，做出以下假设：

1. **删除策略假设**: 采用"禁止删除有关联项目的产品线"策略
2. **编辑功能假设**: 需要支持编辑产品线名称
3. **UI位置假设**: 管理入口放在ProductLineSettings组件顶部
4. **交互方式假设**: 使用侧边抽屉（Drawer）展示管理界面
5. **权限假设**: 所有用户都有完整的产品线管理权限（无权限控制）

## 六、验收标准

### 6.1 功能验收

#### 后端API
- [ ] DELETE /api/productlines/:id 正常工作
- [ ] PUT /api/productlines/:id 正常工作
- [ ] 删除时正确检查项目关联
- [ ] 有关联项目时返回403错误和清晰提示
- [ ] 无关联项目时成功删除
- [ ] 编辑时正确验证数据
- [ ] 所有API返回统一格式的响应

#### 前端功能
- [ ] 可以打开产品线管理抽屉
- [ ] 可以查看所有产品线列表
- [ ] 可以看到每个产品线的关联项目数
- [ ] 可以新建产品线
- [ ] 可以编辑产品线名称
- [ ] 可以删除产品线（无关联项目时）
- [ ] 删除有关联项目的产品线时显示错误提示
- [ ] 可以快速切换产品线显示/隐藏
- [ ] 所有操作后数据实时刷新
- [ ] 所有操作有明确的成功/失败反馈

### 6.2 用户体验验收
- [ ] 操作流程顺畅，无卡顿
- [ ] 错误提示清晰易懂
- [ ] 确认对话框提示明确
- [ ] 抽屉打开/关闭动画流畅
- [ ] 响应式布局适配良好

### 6.3 代码质量验收
- [ ] 所有代码包含完整注释
- [ ] 代码风格与现有项目一致
- [ ] 复用现有组件和工具函数
- [ ] 无console.log等调试代码
- [ ] 异常处理完整

### 6.4 数据完整性验收
- [ ] 删除操作不会导致数据不一致
- [ ] 编辑操作正确更新所有引用
- [ ] 文件锁机制正常工作
- [ ] 并发操作不会导致数据损坏

## 七、下一步行动

1. **等待用户确认**
   - 删除策略选择（推荐选项A）
   - 是否需要编辑功能（推荐增加）

2. **进入Architect阶段**
   - 设计详细的系统架构
   - 定义API接口规范
   - 设计组件结构

3. **进入Atomize阶段**
   - 拆分为可执行的原子任务
   - 明确任务依赖关系
   - 制定实施计划

---

**文档版本**: v1.0  
**创建时间**: 2025-10-16  
**状态**: 待确认
